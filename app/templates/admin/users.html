{% extends "base.html" %}

{% block title %}Manage Users - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-layout">
    <aside class="admin-sidebar">
        <div class="admin-brand">
            <h2>Admin Panel</h2>
        </div>
        <nav class="admin-nav">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="nav-item">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('admin.admin_products') }}" class="nav-item">
                <span class="icon">üì¶</span>
                <span>Products</span>
            </a>
            <a href="#" class="nav-item">
                <span class="icon">üõçÔ∏è</span>
                <span>Orders</span>
            </a>
            <a href="#" class="nav-item active">
                <span class="icon">üë•</span>
                <span>Users</span>
            </a>
            <a href="{{ url_for('main.index') }}" class="nav-item">
                <span class="icon">üè†</span>
                <span>Back to Store</span>
            </a>
        </nav>
    </aside>

    <main class="admin-main">
        <div class="admin-header">
            <h1>User Management</h1>
            <button class="btn btn-primary" onclick="openUserModal()">+ Add New User</button>
        </div>

        <div class="admin-filters">
            <div class="filter-group">
                <input type="text" id="searchUsers" placeholder="Search by name, email, or username..." class="form-control" oninput="filterUsers()">
                <select class="form-control" id="filterRole" onchange="filterUsers()">
                    <option value="">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="customer">Customer</option>
                </select>
                <select class="form-control" id="filterStatus" onchange="filterUsers()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div class="users-grid">
            {% if users %}
                {% for user in users %}
                    <div class="user-card" data-user-id="{{ user.id }}" data-role="{{ 'admin' if user.is_admin else 'customer' }}">
                        <div class="user-avatar">
                            <img src="{{ url_for('static', filename=user.profile_image) if user.profile_image else url_for('static', filename='images/default-avatar.png') }}" alt="{{ user.username }}">
                            {% if user.is_admin %}
                                <span class="admin-badge">Admin</span>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                            <p class="username">@{{ user.username }}</p>
                            <p class="email">{{ user.email }}</p>
                        </div>
                        <div class="user-stats">
                            <div class="stat">
                                <span class="stat-label">Orders:</span>
                                <span class="stat-value">{{ user.orders.count() }}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Total Spent:</span>
                                <span class="stat-value">${{ "%.2f"|format(user.orders|sum(attribute='total_amount') or 0) }}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Member Since:</span>
                                <span class="stat-value">{{ user.created_at.strftime('%b %Y') if user.created_at else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editUser({{ user.id }})">Edit</button>
                            <button class="btn btn-sm btn-outline" onclick="viewUserOrders({{ user.id }})">View Orders</button>
                            {% if not user.is_admin %}
                                <button class="btn btn-sm btn-outline" onclick="toggleAdmin({{ user.id }})">Make Admin</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})">Delete</button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>No users found</p>
                </div>
            {% endif %}
        </div>

        {% if users and users.pages > 1 %}
            <div class="pagination">
                {% if users.has_prev %}
                    <a href="?page={{ users.prev_num }}" class="btn btn-secondary">Previous</a>
                {% endif %}
                <span class="page-info">Page {{ users.page }} of {{ users.pages }}</span>
                {% if users.has_next %}
                    <a href="?page={{ users.next_num }}" class="btn btn-secondary">Next</a>
                {% endif %}
            </div>
        {% endif %}
    </main>
</div>

<!-- User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="userModalTitle">Add New User</h2>
            <span class="close" onclick="closeUserModal()">&times;</span>
        </div>
        <form id="userForm" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="first_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Profile Image</label>
                    <input type="file" name="profile_image" accept="image/*" class="form-control">
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_admin">
                        <span>Admin User</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save User</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const roleFilter = document.getElementById('filterRole').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    const userCards = document.querySelectorAll('.user-card');
    userCards.forEach(card => {
        const userName = card.querySelector('h3').textContent.toLowerCase();
        const username = card.querySelector('.username').textContent.toLowerCase();
        const email = card.querySelector('.email').textContent.toLowerCase();
        const role = card.dataset.role;
        
        const matchesSearch = userName.includes(searchTerm) || 
                            username.includes(searchTerm) || 
                            email.includes(searchTerm);
        const matchesRole = !roleFilter || role === roleFilter;
        
        card.style.display = (matchesSearch && matchesRole) ? 'block' : 'none';
    });
}

function openUserModal() {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('userForm').reset();
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

function editUser(userId) {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'Edit User';
    alert('Edit user feature coming soon! User ID: ' + userId);
}

function viewUserOrders(userId) {
    window.location.href = `/admin/users/${userId}/orders`;
}

function toggleAdmin(userId) {
    if (confirm('Are you sure you want to make this user an admin?')) {
        fetch(`/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User role updated successfully!');
                location.reload();
            } else {
                alert('Failed to update user role');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Admin toggle functionality needs backend implementation.');
        });
    }
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/users/${userId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Delete functionality needs backend implementation.');
        });
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('userModal');
    if (event.target === modal) {
        closeUserModal();
    }
}
</script>
{% endblock %}
